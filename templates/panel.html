<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sağlık AI Asistanı - Kullanıcı Paneli</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #f8fafc; }
        .sidebar { min-height: 100vh; background: #fff; border-right: 1px solid #eee; }
        .sidebar .nav-link.active { background: #0d6efd; color: #fff !important; }
        .sidebar .nav-link { color: #333; }
        .main-content { padding: 2rem; }
        .result-table th, .result-table td { vertical-align: middle; }
        .ai-message { font-style: italic; color: #0d6efd; }
        .alert-area { margin-top: 1rem; }
        .highlight-abnormal { background-color: #fff3cd !important; }
        .alert-critical { background-color: #f8d7da !important; color: #842029 !important; font-weight: bold; }

        .table {
           --bs-body-bg : auto !important;
        }
    </style>
</head>
<body>
<div class="container-fluid">
    <div class="row">
        <nav class="col-md-2 d-none d-md-block sidebar p-0">
            <div class="position-sticky pt-4">
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link active" id="menu-lab" href="#">Laboratuvar Sonucu Gir</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="menu-patient" href="#">Hasta Sonuçlarını Görüntüle</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="menu-aiqa" href="#">AI'ya Soru Sor</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="menu-reportupload" href="#">Rapor Yükle ve Açıkla</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="menu-symptom" href="#">Semptom Analizi</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="menu-clinical" href="#">Klinik Karar Desteği</a>
                    </li>
                    <li class="nav-item" id="menu-admin-li" style="display:none;">
                        <a class="nav-link" id="menu-admin" href="#">Admin Paneli</a>
                    </li>
                </ul>
            </div>
        </nav>
        <main class="col-md-10 ms-sm-auto main-content">
            <!-- Sağ üst köşe butonları -->
            <div style="position:fixed; top:10px; right:20px; z-index:11000;">
                <button id="btnLoginSwitch" class="btn btn-outline-primary btn-sm me-2">Giriş Yap</button>
                <button id="btnLogout" class="btn btn-outline-danger btn-sm">Çıkış Yap</button>
            </div>
            <div id="content-lab">
                <h3>Laboratuvar Sonucu Gir</h3>
                <form id="labForm" class="row g-3">
                    <div class="col-md-6">
                        <label for="testName" class="form-label">Test Adı</label>
                        <select class="form-select" id="testName" required></select>
                    </div>
                    <div class="col-md-3">
                        <label for="value" class="form-label">Değer</label>
                        <input type="number" step="any" class="form-control" id="value" required>
                    </div>
                    <div class="col-md-3">
                        <label for="unit" class="form-label">Birim</label>
                        <input type="text" class="form-control" id="unit" required readonly>
                    </div>
                    <div class="col-md-6">
                        <label for="patientId" class="form-label">Hasta ID</label>
                        <input type="text" class="form-control" id="patientId" required>
                    </div>
                    <div class="col-12">
                        <button type="submit" class="btn btn-primary">Kaydı Gönder</button>
                    </div>
                </form>
                <div id="labResult" class="alert-area"></div>
                <div id="labLoading" style="display:none; text-align:center; margin-top:1rem;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Yükleniyor...</span>
                    </div>
                    <div>AI analizi yapılıyor...</div>
                </div>
            </div>
            <div id="content-patient" style="display:none;">
                <h3>Hasta Sonuçlarını Görüntüle</h3>
                <form id="patientForm" class="row g-3 mb-3">
                    <div class="col-md-4">
                        <label for="searchPatientId" class="form-label">Hasta ID (opsiyonel)</label>
                        <input type="text" class="form-control" id="searchPatientId">
                    </div>
                    <div class="col-md-3">
                        <label for="dateStart" class="form-label">Başlangıç Tarihi</label>
                        <input type="date" class="form-control" id="dateStart">
                    </div>
                    <div class="col-md-3">
                        <label for="dateEnd" class="form-label">Bitiş Tarihi</label>
                        <input type="date" class="form-control" id="dateEnd">
                    </div>
                    <div class="col-12">
                        <button type="submit" class="btn btn-success">Sonuçları Getir</button>
                        <button type="button" class="btn btn-warning ms-2" id="getAdviceBtn">Sağlık Tavsiyesi Al</button>
                        <button type="button" class="btn btn-secondary ms-2" id="getReportBtn">Rapor/Özet Oluştur</button>
                        <button type="button" class="btn btn-danger ms-2" id="getRiskBtn">Risk Analizi</button>
                    </div>
                </form>
                <div id="adviceLoading" style="display:none; text-align:center; margin-bottom:1rem;">
                    <div class="spinner-border text-warning" role="status">
                        <span class="visually-hidden">Yükleniyor...</span>
                    </div>
                    <div>AI sağlık tavsiyesi hazırlanıyor...</div>
                </div>
                <div id="patientAdvice" class="alert-area mb-2"></div>
                <div id="reportLoading" style="display:none; text-align:center; margin-bottom:1rem;">
                    <div class="spinner-border text-secondary" role="status">
                        <span class="visually-hidden">Yükleniyor...</span>
                    </div>
                    <div>AI rapor/özet hazırlanıyor...</div>
                </div>
                <div id="patientReport" class="alert-area mb-2"></div>
                <div id="riskLoading" style="display:none; text-align:center; margin-bottom:1rem;">
                    <div class="spinner-border text-danger" role="status">
                        <span class="visually-hidden">Yükleniyor...</span>
                    </div>
                    <div>AI risk analizi hazırlanıyor...</div>
                </div>
                <div id="patientRisk" class="alert-area mb-2"></div>
                <div id="patientResults"></div>
            </div>
            <div id="content-aiqa" style="display:none;">
                <div id="ai-qa-box" class="mb-4">
                    <h3>AI'ya Soru Sor</h3>
                    <form id="aiQaForm" class="row g-2">
                        <div class="col-md-10">
                            <input type="text" class="form-control" id="aiQuestion" placeholder="Sağlıkla ilgili sorunuzu yazın..." required>
                        </div>
                        <div class="col-md-2">
                            <button type="submit" class="btn btn-info w-100">Sor</button>
                        </div>
                    </form>
                    <div id="aiQaLoading" style="display:none; text-align:center; margin-top:1rem;">
                        <div class="spinner-border text-info" role="status">
                            <span class="visually-hidden">Yükleniyor...</span>
                        </div>
                        <div>AI yanıtlıyor...</div>
                    </div>
                    <div id="aiQaAnswer" class="alert-area mt-2"></div>
                </div>
            </div>
            <div id="content-reportupload" style="display:none;">
                <h3>Rapor Yükle ve Açıkla</h3>
                <form id="reportUploadForm" enctype="multipart/form-data" class="mb-3">
                    <div class="mb-2">
                        <input type="file" class="form-control" id="reportFile" accept=".pdf,.txt,.jpg,.jpeg,.png,.bmp,.tiff,.gif">
                    </div>
                    <button type="submit" class="btn btn-primary">Yükle ve Açıkla</button>
                </form>
                <div id="reportUploadLoading" style="display:none; text-align:center; margin-bottom:1rem;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Yükleniyor...</span>
                    </div>
                    <div>AI raporu analiz ediyor...</div>
                </div>
                <div id="reportUploadResult" class="alert-area"></div>
            </div>
            <div id="content-symptom" style="display:none;">
                <h3>Semptom Analizi</h3>
                <form id="symptomForm" class="mb-3">
                    <textarea class="form-control mb-2" id="symptomText" rows="3" placeholder="Semptomlarınızı ve şikayetlerinizi yazın..."></textarea>
                    <button type="submit" class="btn btn-danger">Analiz Et</button>
                </form>
                <div id="symptomLoading" style="display:none; text-align:center; margin-bottom:1rem;">
                    <div class="spinner-border text-danger" role="status">
                        <span class="visually-hidden">Yükleniyor...</span>
                    </div>
                    <div>AI semptomlarınızı analiz ediyor...</div>
                </div>
                <div id="symptomResult" class="alert-area"></div>
            </div>
            <div id="content-clinical" style="display:none;">
                <h3>Klinik Karar Desteği</h3>
                <form id="clinicalForm" class="mb-3">
                    <textarea class="form-control mb-2" id="clinicalHistory" rows="2" placeholder="Hasta öyküsü, şikayetler, fizik muayene bulguları..."></textarea>
                    <textarea class="form-control mb-2" id="clinicalLabs" rows="2" placeholder="Laboratuvar sonuçları (örn: Hb: 12.3 g/dL, WBC: 8.2 10^9/L, ...)"></textarea>
                    <button type="submit" class="btn btn-success">AI'dan Klinik Öneri Al</button>
                </form>
                <div id="clinicalLoading" style="display:none; text-align:center; margin-bottom:1rem;">
                    <div class="spinner-border text-success" role="status">
                        <span class="visually-hidden">Yükleniyor...</span>
                    </div>
                    <div>AI klinik karar desteği sağlıyor...</div>
                </div>
                <div id="clinicalResult" class="alert-area"></div>
            </div>
            <div id="content-admin" style="display:none;">
                <h3>Admin Paneli - Doktor Yönetimi</h3>
                <form id="adminAddDoctorForm" class="row g-3 mb-3">
                    <div class="col-md-3">
                        <input type="text" class="form-control" id="adminDoctorUsername" placeholder="Kullanıcı Adı" required>
                    </div>
                    <div class="col-md-3">
                        <input type="text" class="form-control" id="adminDoctorName" placeholder="Ad Soyad" required>
                    </div>
                    <div class="col-md-3">
                        <input type="password" class="form-control" id="adminDoctorPassword" placeholder="Şifre" required>
                    </div>
                    <div class="col-md-2">
                        <select class="form-select" id="adminDoctorIsAdmin">
                            <option value="0">Normal Doktor</option>
                            <option value="1">Admin</option>
                        </select>
                    </div>
                    <div class="col-md-1">
                        <button type="submit" class="btn btn-success w-100">Ekle</button>
                    </div>
                </form>
                <div id="adminDoctorError" class="alert alert-danger" style="display:none;"></div>
                <div id="adminDoctorList"></div>
            </div>
        </main>
    </div>
</div>
<div id="roleLoginModal" class="modal" tabindex="-1" style="display:none; background:rgba(0,0,0,0.5); position:fixed; top:0; left:0; width:100vw; height:100vh; z-index:10000;">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Giriş Yap</h5>
      </div>
      <div class="modal-body text-center">
        <button class="btn btn-primary w-100 mb-3" id="loginAsPatient">Hasta olarak giriş yap</button>
        <button class="btn btn-success w-100" id="loginAsDoctor">Doktor olarak giriş yap</button>
      </div>
    </div>
  </div>
</div>
<div id="doctorLoginModal" class="modal" tabindex="-1" style="display:none; background:rgba(0,0,0,0.3); position:fixed; top:0; left:0; width:100vw; height:100vh; z-index:9999;">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Doktor Girişi</h5>
      </div>
      <div class="modal-body">
        <input type="text" class="form-control mb-2" id="doctorUsername" placeholder="Kullanıcı Adı">
        <input type="password" class="form-control mb-2" id="doctorPassword" placeholder="Şifre">
        <div id="doctorLoginError" class="text-danger" style="display:none;">Hatalı kullanıcı adı veya şifre!</div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" id="doctorLoginBtn">Giriş Yap</button>
      </div>
    </div>
  </div>
</div>
<!-- Yeni doktor seçme modalı -->
<div class="modal" tabindex="-1" id="reassignDoctorModal" style="display:none; background:rgba(0,0,0,0.3); position:fixed; top:0; left:0; width:100vw; height:100vh; z-index:12000;">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Hastaları Yeni Doktora Ata</h5>
      </div>
      <div class="modal-body">
        <select class="form-select" id="reassignDoctorSelect"></select>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" id="reassignCancelBtn">Vazgeç</button>
        <button type="button" class="btn btn-primary" id="reassignConfirmBtn">Onayla ve Sil</button>
      </div>
    </div>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
window.addEventListener('DOMContentLoaded', function() {
    // Menü ve içerik elementlerini DOM yüklendikten sonra tanımla
    const menuLab = document.getElementById('menu-lab');
    const menuPatient = document.getElementById('menu-patient');
    const menuAiqa = document.getElementById('menu-aiqa');
    const menuReportupload = document.getElementById('menu-reportupload');
    const menuSymptom = document.getElementById('menu-symptom');
    const menuClinical = document.getElementById('menu-clinical');
    const menuAdminLi = document.getElementById('menu-admin-li');
    const menuAdmin = document.getElementById('menu-admin');
    const contentLab = document.getElementById('content-lab');
    const contentPatient = document.getElementById('content-patient');
    const contentAiqa = document.getElementById('content-aiqa');
    const contentReportupload = document.getElementById('content-reportupload');
    const contentSymptom = document.getElementById('content-symptom');
    const contentClinical = document.getElementById('content-clinical');
    const contentAdmin = document.getElementById('content-admin');

    // Menü geçişleri (role ve login kontrolüyle)
    menuLab.addEventListener('click', function(e) {
        e.preventDefault();
        if (getRole() !== 'doctor' || !isDoctorLoggedIn()) return;
        setActiveMenu('lab');
    });
    menuPatient.addEventListener('click', function(e) {
        e.preventDefault();
        setActiveMenu('patient');
    });
    menuAiqa.addEventListener('click', function(e) {
        e.preventDefault();
        setActiveMenu('aiqa');
    });
    menuReportupload.addEventListener('click', function(e) {
        e.preventDefault();
        setActiveMenu('reportupload');
    });
    menuSymptom.addEventListener('click', function(e) {
        e.preventDefault();
        setActiveMenu('symptom');
    });
    menuClinical.addEventListener('click', function(e) {
        e.preventDefault();
        setActiveMenu('clinical');
    });
    menuAdmin.addEventListener('click', function(e) {
        e.preventDefault();
        setActiveMenu('admin');
    });

    function setActiveMenu(menu) {
        // Tüm menüleri ve içerikleri pasifleştir
        menuLab.classList.remove('active');
        menuPatient.classList.remove('active');
        menuAiqa.classList.remove('active');
        menuReportupload.classList.remove('active');
        menuSymptom.classList.remove('active');
        menuClinical.classList.remove('active');
        menuAdminLi.style.display = 'none';
        contentLab.style.display = 'none';
        contentPatient.style.display = 'none';
        contentAiqa.style.display = 'none';
        contentReportupload.style.display = 'none';
        contentSymptom.style.display = 'none';
        contentClinical.style.display = 'none';
        contentAdmin.style.display = 'none';
        // Seçili menü ve içeriği aktif et
        if(menu === 'lab') {
            menuLab.classList.add('active');
            contentLab.style.display = '';
        } else if(menu === 'patient') {
            menuPatient.classList.add('active');
            contentPatient.style.display = '';
        } else if(menu === 'aiqa') {
            menuAiqa.classList.add('active');
            contentAiqa.style.display = '';
        } else if(menu === 'reportupload') {
            menuReportupload.classList.add('active');
            contentReportupload.style.display = '';
        } else if(menu === 'symptom') {
            menuSymptom.classList.add('active');
            contentSymptom.style.display = '';
        } else if(menu === 'clinical') {
            menuClinical.classList.add('active');
            contentClinical.style.display = '';
        } else if(menu === 'admin') {
            menuAdminLi.style.display = '';
            contentAdmin.style.display = '';
        }
    }

    // Giriş modalı ve role UI güncelleme kodları zaten burada
    if (!getRole()) {
        showRoleLogin();
    } else {
        updateRoleUI();
        if (getRole() === 'doctor' && !isDoctorLoggedIn()) {
            showDoctorLogin();
        }
    }

    // Giriş/Çıkış butonları
    const btnLoginSwitch = document.getElementById('btnLoginSwitch');
    const btnLogout = document.getElementById('btnLogout');
    btnLoginSwitch.addEventListener('click', function() {
        clearRole();
        clearDoctorLogin();
        showRoleLogin();
    });
    btnLogout.addEventListener('click', function() {
        clearRole();
        clearDoctorLogin();
        location.reload();
    });

    // Admin panel menü ve içerik
    function updateRoleUI() {
        const role = getRole();
        const isAdmin = localStorage.getItem('is_admin') === '1';
        if (role === 'patient') {
            document.getElementById('menu-lab').style.display = 'none';
            document.getElementById('content-lab').style.display = 'none';
            menuAdminLi.style.display = 'none';
        } else if (role === 'doctor') {
            document.getElementById('menu-lab').style.display = '';
            if (isDoctorLoggedIn()) {
                document.getElementById('content-lab').style.display = '';
                menuAdminLi.style.display = isAdmin ? '' : 'none';
            } else {
                menuAdminLi.style.display = 'none';
            }
        }
    }

    function showRoleLogin() {
        roleLoginModal.style.display = 'block';
    }
    function hideRoleLogin() {
        roleLoginModal.style.display = 'none';
    }
    function setRole(role) {
        localStorage.setItem('user_role', role);
    }
    function getRole() {
        return localStorage.getItem('user_role');
    }
    function clearRole() {
        localStorage.removeItem('user_role');
    }

    loginAsPatient.addEventListener('click', function() {
        setRole('patient');
        hideRoleLogin();
        updateRoleUI();
    });
    loginAsDoctor.addEventListener('click', function() {
        setRole('doctor');
        hideRoleLogin();
        showDoctorLogin();
    });

    function showDoctorLogin() {
        doctorLoginModal.style.display = 'block';
        doctorUsername.value = '';
        doctorPassword.value = '';
        doctorLoginError.style.display = 'none';
        doctorUsername.focus();
    }
    function hideDoctorLogin() {
        doctorLoginModal.style.display = 'none';
    }
    function isDoctorLoggedIn() {
        return !!localStorage.getItem('doctor_token');
    }
    function setDoctorLoggedIn(token, doctorName, isAdmin) {
        localStorage.setItem('doctor_token', token);
        localStorage.setItem('doctor_name', doctorName);
        localStorage.setItem('is_admin', isAdmin);
        updateRoleUI();
    }
    function clearDoctorLogin() {
        localStorage.removeItem('doctor_token');
        localStorage.removeItem('doctor_name');
    }

    // Test adlarını ve LOINC kodlarını doldur
    let testLoincMap = {};
    fetch('/lab/tests')
        .then(r => r.json())
        .then(data => {
            const testNameSelect = document.getElementById('testName');
            testNameSelect.innerHTML = '';
            data.available_tests.forEach((name, idx) => {
                const opt = new Option(name, name);
                testNameSelect.appendChild(opt);
            });
            // Eğer bir şey seçili değilse ilkini seç
            if (!testNameSelect.value && testNameSelect.options.length > 0) {
                testNameSelect.selectedIndex = 0;
            }
            updateUnit(); // Test adları yüklendikten sonra birim otomatik gelsin
        });

    // Test adı seçilince birimi otomatik doldur ve input'u readonly yap
    const testNameSelect = document.getElementById('testName');
    const unitInput = document.getElementById('unit');
    let loincMap = {
        "Hemoglobin": "718-7",
        "Beyaz Kan Hücresi (WBC)": "6690-2",
        "Trombosit (Platelet)": "777-3",
        "Hematokrit": "789-8",
        "Sodyum": "2951-2",
        "Potasyum": "2823-3",
        "Kreatinin": "2075-0",
        "Glukoz (Açlık)": "2345-7",
        "Total Kolesterol": "2093-3",
        "HDL Kolesterol": "2085-9",
        "LDL Kolesterol": "13457-7",
        "Trigliserid": "2571-8",
        "ALT (SGPT)": "4548-4",
        "AST (SGOT)": "1920-8",
        "Alkalin Fosfataz": "2885-2",
        "Üre Azotu (BUN)": "3094-0",
        "Bilirubin Total": "1751-7",
        "Albumin": "1925-7",
        "TSH (Tiroid Stimulan Hormon)": "14957-5",
        "Serbest T4": "14647-2",
        "Serbest T3": "14598-7",
        "CRP (C-Reaktif Protein)": "1986-5",
        "Vitamin D (25-OH)": "30000-4",
        "Ferritin": "10466-1",
        "HbA1c": "14979-9"
    };
    async function updateUnit() {
        const testName = testNameSelect.value;
        console.log('updateUnit tetiklendi, test:', testName);
        const loinc = loincMap[testName];
        if (!loinc) {
            unitInput.value = '';
            unitInput.readOnly = true;
            return;
        }
        // Referans API'den birimi çek
        try {
            const res = await fetch(`http://127.0.0.1:8001/reference-range?loinc=${loinc}`);
            if (res.ok) {
                const data = await res.json();
                unitInput.value = data.unit;
                unitInput.readOnly = true;
            } else {
                unitInput.value = '';
                unitInput.readOnly = true;
            }
        } catch {
            unitInput.value = '';
            unitInput.readOnly = true;
        }
    }
    testNameSelect.addEventListener('change', updateUnit);
    testNameSelect.addEventListener('input', updateUnit);
    document.addEventListener('DOMContentLoaded', updateUnit);

    // Laboratuvar sonucu gönderme
    const labForm = document.getElementById('labForm');
    const labLoading = document.getElementById('labLoading');
    labForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const testName = document.getElementById('testName').value;
        const value = document.getElementById('value').value;
        const unit = document.getElementById('unit').value;
        const patientId = document.getElementById('patientId').value;
        if (!unit) {
            document.getElementById('labResult').innerHTML = `<div class='alert alert-danger'>Birim bilgisi yüklenemedi. Lütfen başka bir test seçip tekrar deneyin.</div>`;
            return;
        }
        labLoading.style.display = '';
        let text = `${testName}: ${value} ${unit}, Hasta: ${patientId}`;
        fetch('/lab/text', {
            method: 'POST',
            headers: {
                'Content-Type': 'text/plain',
                'Authorization': 'Bearer ' + (localStorage.getItem('doctor_token') || '')
            },
            body: text
        })
        .then(r => r.json())
        .then(data => {
            labLoading.style.display = 'none';
            const resultDiv = document.getElementById('labResult');
            if(data.status === 'success') {
                resultDiv.innerHTML = `<div class='alert alert-success'>Kayıt başarılı!</div>`;
                labForm.reset();
                updateUnit();
            } else {
                resultDiv.innerHTML = `<div class='alert alert-danger'>${data.error || data.message || 'Bir hata oluştu.'}</div>`;
            }
        })
        .catch(() => {
            labLoading.style.display = 'none';
            document.getElementById('labResult').innerHTML = `<div class='alert alert-danger'>Sunucu hatası!</div>`;
        });
    });

    // Hasta sonuçlarını getirme
    const patientForm = document.getElementById('patientForm');
    const patientResults = document.getElementById('patientResults');
    const getAdviceBtn = document.getElementById('getAdviceBtn');
    const adviceLoading = document.getElementById('adviceLoading');
    const patientAdvice = document.getElementById('patientAdvice');
    const getReportBtn = document.getElementById('getReportBtn');
    const reportLoading = document.getElementById('reportLoading');
    const patientReport = document.getElementById('patientReport');
    const getRiskBtn = document.getElementById('getRiskBtn');
    const riskLoading = document.getElementById('riskLoading');
    const patientRisk = document.getElementById('patientRisk');

    patientForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const patientId = document.getElementById('searchPatientId').value;
        const dateStart = document.getElementById('dateStart').value;
        const dateEnd = document.getElementById('dateEnd').value;
        let url = '/patient/results?';
        if (patientId) url += `patient_id=${encodeURIComponent(patientId)}&`;
        if (dateStart) url += `date_start=${encodeURIComponent(dateStart)}&`;
        if (dateEnd) url += `date_end=${encodeURIComponent(dateEnd)}&`;
        fetch(url)
            .then(r => r.json())
            .then(async data => {
                if(data.info){
                    patientResults.innerHTML = `<div class='alert alert-warning'>${data.info}</div>`;
                    return;
                }
                if(data.length === 0) {
                    patientResults.innerHTML = `<div class='alert alert-info'>Kayıt bulunamadı.</div>`;
                    return;
                }
                let refCache = {};
                let html = `<div class='table-responsive'><table class='table result-table'><thead><tr><th>Hasta ID</th><th>Test Adı</th><th>Değer</th><th>Birim</th><th>Tarih</th><th>AI Analizi</th><th>Sorumlu Doktor</th></tr></thead><tbody>`;
                for (const r of data) {
                    let rowClass = '';
                    let ref = null;
                    const loinc = loincMap[r.test_name];
                    if (loinc) {
                        if (!refCache[loinc]) {
                            try {
                                const res = await fetch(`http://127.0.0.1:8001/reference-range?loinc=${loinc}`);
                                if (res.ok) refCache[loinc] = await res.json();
                            } catch {}
                        }
                        ref = refCache[loinc];
                    }
                    if (ref && typeof r.value === 'number') {
                        if (r.value < ref.normal_min) rowClass = 'highlight-abnormal';
                        else if (r.value > ref.normal_max) rowClass = 'alert-critical';
                    }
                    html += `<tr class='${rowClass}'><td>${r.patient_id || ''}</td><td>${r.test_name}</td><td>${r.value}</td><td>${r.unit}</td><td>${new Date(r.date).toLocaleString('tr-TR')}</td><td>${r.ai_analysis || 'Normal veya analiz edilmedi.'}</td><td>${r.doctor_name || '-'}</td></tr>`;
                }
                html += `</tbody></table></div>`;
                patientResults.innerHTML = html;
            })
            .catch(() => {
                patientResults.innerHTML = `<div class='alert alert-danger'>Sunucu hatası!</div>`;
            });
    });

    getAdviceBtn.addEventListener('click', function() {
        const patientId = document.getElementById('searchPatientId').value;
        if (!patientId) {
            patientAdvice.innerHTML = `<div class='alert alert-warning'>Lütfen önce bir Hasta ID girin.</div>`;
            return;
        }
        adviceLoading.style.display = '';
        patientAdvice.innerHTML = '';
        fetch('/patient/advice', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ patient_id: patientId })
        })
        .then(r => r.json())
        .then(data => {
            adviceLoading.style.display = 'none';
            if(data.advice) {
                patientAdvice.innerHTML = `<div class='alert alert-warning'><b>AI Tavsiye:</b> ${data.advice}</div>`;
            } else {
                patientAdvice.innerHTML = `<div class='alert alert-danger'>${data.error || 'Tavsiye alınamadı.'}</div>`;
            }
        })
        .catch(() => {
            adviceLoading.style.display = 'none';
            patientAdvice.innerHTML = `<div class='alert alert-danger'>Sunucu hatası!</div>`;
        });
    });

    getReportBtn.addEventListener('click', function() {
        const patientId = document.getElementById('searchPatientId').value;
        if (!patientId) {
            patientReport.innerHTML = `<div class='alert alert-warning'>Lütfen önce bir Hasta ID girin.</div>`;
            return;
        }
        reportLoading.style.display = '';
        patientReport.innerHTML = '';
        fetch('/patient/report', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ patient_id: patientId })
        })
        .then(r => r.json())
        .then(data => {
            reportLoading.style.display = 'none';
            if(data.report) {
                patientReport.innerHTML = `<div class='alert alert-secondary'><b>AI Rapor/Özet:</b><br>${data.report}</div>`;
            } else {
                patientReport.innerHTML = `<div class='alert alert-danger'>${data.error || 'Rapor alınamadı.'}</div>`;
            }
        })
        .catch(() => {
            reportLoading.style.display = 'none';
            patientReport.innerHTML = `<div class='alert alert-danger'>Sunucu hatası!</div>`;
        });
    });

    getRiskBtn.addEventListener('click', function() {
        const patientId = document.getElementById('searchPatientId').value;
        if (!patientId) {
            patientRisk.innerHTML = `<div class='alert alert-warning'>Lütfen önce bir Hasta ID girin.</div>`;
            return;
        }
        riskLoading.style.display = '';
        patientRisk.innerHTML = '';
        fetch('/patient/risk', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ patient_id: patientId })
        })
        .then(r => r.json())
        .then(data => {
            riskLoading.style.display = 'none';
            if(data.risk) {
                patientRisk.innerHTML = `<div class='alert alert-danger'><b>AI Risk Analizi:</b><br>${data.risk}</div>`;
            } else {
                patientRisk.innerHTML = `<div class='alert alert-danger'>${data.error || 'Risk analizi alınamadı.'}</div>`;
            }
        })
        .catch(() => {
            riskLoading.style.display = 'none';
            patientRisk.innerHTML = `<div class='alert alert-danger'>Sunucu hatası!</div>`;
        });
    });

    // AI Soru-Cevap
    const aiQaForm = document.getElementById('aiQaForm');
    const aiQaLoading = document.getElementById('aiQaLoading');
    const aiQaAnswer = document.getElementById('aiQaAnswer');
    aiQaForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const question = document.getElementById('aiQuestion').value;
        aiQaLoading.style.display = '';
        aiQaAnswer.innerHTML = '';
        fetch('/ask-ai', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ question })
        })
        .then(r => r.json())
        .then(data => {
            aiQaLoading.style.display = 'none';
            if(data.answer) {
                aiQaAnswer.innerHTML = `<div class='alert alert-info'><b>AI:</b> ${data.answer}</div>`;
            } else {
                aiQaAnswer.innerHTML = `<div class='alert alert-warning'>Yanıt alınamadı.</div>`;
            }
        })
        .catch(() => {
            aiQaLoading.style.display = 'none';
            aiQaAnswer.innerHTML = `<div class='alert alert-danger'>Sunucu hatası!</div>`;
        });
    });

    // Rapor yükleme
    const reportUploadForm = document.getElementById('reportUploadForm');
    const reportUploadLoading = document.getElementById('reportUploadLoading');
    const reportUploadResult = document.getElementById('reportUploadResult');
    reportUploadForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const fileInput = document.getElementById('reportFile');
        if (!fileInput.files || fileInput.files.length === 0) {
            reportUploadResult.innerHTML = `<div class='alert alert-warning'>Lütfen bir dosya seçin.</div>`;
            return;
        }
        const formData = new FormData();
        formData.append('file', fileInput.files[0]);
        reportUploadLoading.style.display = '';
        reportUploadResult.innerHTML = '';
        fetch('/report/analyze', {
            method: 'POST',
            body: formData
        })
        .then(r => r.json())
        .then(data => {
            reportUploadLoading.style.display = 'none';
            if(data.explanation) {
                reportUploadResult.innerHTML = `<div class='alert alert-info'><b>AI Açıklama:</b><br>${data.explanation}</div>`;
            } else {
                reportUploadResult.innerHTML = `<div class='alert alert-danger'>${data.error || 'Açıklama alınamadı.'}</div>`;
            }
        })
        .catch(() => {
            reportUploadLoading.style.display = 'none';
            reportUploadResult.innerHTML = `<div class='alert alert-danger'>Sunucu hatası!</div>`;
        });
    });

    // Semptom analizi
    const symptomForm = document.getElementById('symptomForm');
    const symptomLoading = document.getElementById('symptomLoading');
    const symptomResult = document.getElementById('symptomResult');
    symptomForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const text = document.getElementById('symptomText').value;
        if (!text || text.trim() === '') {
            symptomResult.innerHTML = `<div class='alert alert-warning'>Lütfen semptomlarınızı yazın.</div>`;
            return;
        }
        symptomLoading.style.display = '';
        symptomResult.innerHTML = '';
        fetch('/symptom/analyze', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ text })
        })
        .then(r => r.json())
        .then(data => {
            symptomLoading.style.display = 'none';
            if(data.analysis) {
                symptomResult.innerHTML = `<div class='alert alert-danger'><b>AI Analiz:</b><br>${data.analysis}</div>`;
            } else {
                symptomResult.innerHTML = `<div class='alert alert-danger'>${data.error || 'Analiz alınamadı.'}</div>`;
            }
        })
        .catch(() => {
            symptomLoading.style.display = 'none';
            symptomResult.innerHTML = `<div class='alert alert-danger'>Sunucu hatası!</div>`;
        });
    });

    // Klinik Karar Desteği
    const clinicalForm = document.getElementById('clinicalForm');
    const clinicalLoading = document.getElementById('clinicalLoading');
    const clinicalResult = document.getElementById('clinicalResult');
    clinicalForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const history = document.getElementById('clinicalHistory').value;
        const labs = document.getElementById('clinicalLabs').value;
        if (!history && !labs) {
            clinicalResult.innerHTML = `<div class='alert alert-warning'>Lütfen hasta öyküsü veya laboratuvar sonucu girin.</div>`;
            return;
        }
        clinicalLoading.style.display = '';
        clinicalResult.innerHTML = '';
        fetch('/clinical/decision', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ history, labs })
        })
        .then(r => r.json())
        .then(data => {
            clinicalLoading.style.display = 'none';
            if(data.suggestion) {
                clinicalResult.innerHTML = `<div class='alert alert-success'><b>AI Klinik Öneri:</b><br>${data.suggestion}</div>`;
            } else {
                clinicalResult.innerHTML = `<div class='alert alert-danger'>${data.error || 'Klinik öneri alınamadı.'}</div>`;
            }
        })
        .catch(() => {
            clinicalLoading.style.display = 'none';
            clinicalResult.innerHTML = `<div class='alert alert-danger'>Sunucu hatası!</div>`;
        });
    });

    doctorLoginBtn.addEventListener('click', function() {
        const username = doctorUsername.value.trim();
        const password = doctorPassword.value;
        if (!username || !password) {
            doctorLoginError.innerText = 'Kullanıcı adı ve şifre zorunlu!';
            doctorLoginError.style.display = 'block';
            return;
        }
        doctorLoginBtn.disabled = true;
        fetch('/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password })
        })
        .then(r => r.json())
        .then(data => {
            doctorLoginBtn.disabled = false;
            if (data.access_token) {
                setDoctorLoggedIn(data.access_token, data.doctor.name, data.doctor.is_admin);
                hideDoctorLogin();
                contentLab.style.display = '';
                doctorLoginError.style.display = 'none';
                document.getElementById('doctorWelcome')?.remove();
                const welcome = document.createElement('div');
                welcome.id = 'doctorWelcome';
                welcome.className = 'alert alert-info mb-2';
                welcome.innerHTML = `<b>Hoş geldiniz, ${data.doctor.name}</b>`;
                contentLab.prepend(welcome);
            } else {
                doctorLoginError.innerText = data.error || 'Hatalı kullanıcı adı veya şifre!';
                doctorLoginError.style.display = 'block';
            }
        })
        .catch(() => {
            doctorLoginBtn.disabled = false;
            doctorLoginError.innerText = 'Sunucu hatası!';
            doctorLoginError.style.display = 'block';
        });
    });

    doctorUsername.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') doctorLoginBtn.click();
    });

    // Doktorları listele
    function loadDoctors() {
        fetch('/admin/doctors', {
            headers: {'Authorization': 'Bearer ' + (localStorage.getItem('doctor_token') || '')}
        })
            .then(r => r.json())
            .then(data => {
                let html = `<table class='table'><thead><tr><th>Kullanıcı Adı</th><th>Ad Soyad</th><th>Oluşturulma</th><th>Yetki</th><th></th></tr></thead><tbody>`;
                for(const d of data) {
                    html += `<tr><td>${d.username}</td><td>${d.name}</td><td>${new Date(d.created_at).toLocaleString('tr-TR')}</td><td>${d.is_admin === '1' ? 'Admin' : 'Doktor'}</td><td><button class='btn btn-danger btn-sm' data-id='${d.id}'>Sil</button></td></tr>`;
                }
                html += `</tbody></table>`;
                document.getElementById('adminDoctorList').innerHTML = html;
            });
    }
    // Silme işlemi event delegation ile
    let doctorToDelete = null;
    document.getElementById('adminDoctorList').addEventListener('click', function(e) {
        if(e.target && e.target.classList.contains('btn-danger')) {
            const id = e.target.getAttribute('data-id');
            doctorToDelete = id;
            if(!confirm('Bu doktoru silmek istediğinize emin misiniz?')) return;
            fetch(`/admin/doctors/${id}`, {
                method:'DELETE',
                headers: {'Authorization': 'Bearer ' + (localStorage.getItem('doctor_token') || '')}
            })
            .then(r => r.json())
            .then(data => {
                if(data.status === 'success') loadDoctors();
                else if(data.error && data.error.includes('hastalar var')) {
                    // Yeni doktor seçme modalını aç
                    showReassignModal(id);
                } else {
                    alert(data.error || 'Silme işlemi başarısız!');
                }
            });
        }
    });
    // Yeni doktor seçme modalı fonksiyonları
    function showReassignModal(deletedDoctorId) {
        // Diğer doktorları getir
        fetch('/admin/doctors', {
            headers: {'Authorization': 'Bearer ' + (localStorage.getItem('doctor_token') || '')}
        })
        .then(r => r.json())
        .then(data => {
            const select = document.getElementById('reassignDoctorSelect');
            select.innerHTML = '';
            for(const d of data) {
                if(d.id !== deletedDoctorId) {
                    const opt = document.createElement('option');
                    opt.value = d.id;
                    opt.textContent = d.name + ' (' + d.username + ')';
                    select.appendChild(opt);
                }
            }
            document.getElementById('reassignDoctorModal').style.display = 'block';
        });
    }
    document.getElementById('reassignCancelBtn').addEventListener('click', function() {
        document.getElementById('reassignDoctorModal').style.display = 'none';
        doctorToDelete = null;
    });
    document.getElementById('reassignConfirmBtn').addEventListener('click', function() {
        const newDoctorId = document.getElementById('reassignDoctorSelect').value;
        fetch(`/admin/doctors/${doctorToDelete}`, {
            method:'DELETE',
            headers: {
                'Authorization': 'Bearer ' + (localStorage.getItem('doctor_token') || ''),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({new_doctor_id: newDoctorId})
        })
        .then(r => r.json())
        .then(data => {
            document.getElementById('reassignDoctorModal').style.display = 'none';
            doctorToDelete = null;
            if(data.status === 'success') loadDoctors();
            else alert(data.error || 'Silme işlemi başarısız!');
        });
    });
    // Doktor ekleme
    document.getElementById('adminAddDoctorForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const username = document.getElementById('adminDoctorUsername').value;
        const name = document.getElementById('adminDoctorName').value;
        const password = document.getElementById('adminDoctorPassword').value;
        const is_admin = document.getElementById('adminDoctorIsAdmin').value;
        fetch('/admin/doctors', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + (localStorage.getItem('doctor_token') || '')
            },
            body: JSON.stringify({username, name, password, is_admin})
        })
        .then(r => r.json())
        .then(data => {
            if(data.status === 'success') {
                document.getElementById('adminDoctorError').style.display = 'none';
                loadDoctors();
                document.getElementById('adminAddDoctorForm').reset();
            } else {
                document.getElementById('adminDoctorError').innerText = data.error || 'Hata';
                document.getElementById('adminDoctorError').style.display = '';
            }
        });
    });
    // Admin paneline ilk girildiğinde doktorları yükle
    menuAdmin.addEventListener('click', loadDoctors);
});
</script>
</body>
</html>